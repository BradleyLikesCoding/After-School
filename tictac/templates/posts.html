<!doctype html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View TicTacs</title>
    <style>
        #comment-div {
            position: absolute;
            width: 50%;
            height: 75%;
            top: 50%;
            left: 50%;
            background: silver;
            transform: translate(-50%, -50%);
            -ms-transform: translate(-50%, -25%)
        }
    </style>
</head>
<body>
    <div id="comment-div" hidden>
        <div style="height:15%;">
            <h2 style="float: left;">Comments</h2>
            <div onclick="this.parentNode.parentNode.hidden = true;" style="cursor: pointer; font-size:50px; line-height: 1em; float: right;">&times;</div>
        </div>
        <form id="commentForm" action="/comment" metod="post">
            <input type="hidden" id="formPostId" name="post_id" />
            <label for="comment">Comment: </label>
            <input required id="comment" autocomplete="false" type="text" maxlength="256" name="text" />
            <input type="submit" />
        </form>
        <p id="error" hidden>Error posting comment</p>
        <div id="comments">Loading...</div>
    </div>
    <a href="/"><h1>TicTac Home</h1></a>
    <h2>View TicTacs</h2>
    {% for post in posts %}
    <div style="border-style: solid; margin-left: 15px; margin-right:15px">
        <p>Posted by {{ post.name }}</p>
        <h2 style="display: inline;">{{ post.title }}</h2>
        <p>{{ post.body }}</p>
        <img onclick="loadComments({{ post.post_id }})" width="32" height="32" src="{{url_for('static', filename='message.svg')}}" />
    </div>
    {% endfor %}
    <script>
        async function loadComments(post_id) {
            const commentDiv = document.getElementById("comment-div");
            const commentEl = document.getElementById("comments");
            commentEl.innerHTML = "Loading...";
            commentDiv.hidden = false;
            commentRequest = await fetch("/comments?id=" + post_id)
            var val = await commentRequest.text();
            commentEl.innerHTML = val;
            document.getElementById("formPostId").value = post_id;
        }
        const comment = document.getElementById("comment");
        const err = document.getElementById("error");
        const commentForm = document.getElementById("commentForm");
        commentForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const r = await fetch("/comment", {
                method: "POST",
                body: new FormData(commentForm)
            });
            if (r.ok) {
                comment.value = "";
                err.hidden = true;
            } else {
                if (await r.text() == "notloggedin") {
                    err.innerHTML = "You need to <a href=\"{{url_for('login')}}\">login</a> or <a href=\"{{url_for('signup')}}\">signup</a> in order to post a comment."
                    err.hidden = false;
                } else {
                    err.innerHTML = "Error posting comment"
                    err.hidden = false;
                }
            }
        });
    </script>
</body>
</html>